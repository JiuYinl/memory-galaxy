<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liora's Memory Galaxy V4.3 - Expanded</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* --- Ê†∏ÂøÉÂ≠ó‰ΩìÔºöÁ≥ªÁªüÂéüÁîüÊó†Ë°¨Á∫ø --- */
        :root {
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            
            /* üåô Â§úÊôöÊ®°Âºè */
            --bg-color: #050508;
            --bg-gradient: radial-gradient(circle at 20% 30%, #2f2f4a 0%, transparent 40%),
                           radial-gradient(circle at 80% 70%, #1d2a4c 0%, transparent 40%),
                           radial-gradient(circle at 50% 50%, #000000 0%, #13131f 100%);
            
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            
            /* ÂØπËØùÊ°Ü */
            --modal-bg: rgba(10, 10, 15, 0.9);
            --modal-border: rgba(100, 200, 255, 0.2);
            --modal-shadow: 0 0 50px rgba(0, 50, 150, 0.2);
            
            --accent-color: #ffffff; 
            --dot-user: #ffffff;
            --dot-bot: #ffffff;
        }

        [data-theme="day"] {
            /* ‚òÄÔ∏è ÁôΩÂ§©Ê®°Âºè */
            --bg-color: #fdfbff;
            --bg-gradient: radial-gradient(at 10% 10%, rgba(236, 200, 232, 0.5) 0px, transparent 50%),
                           radial-gradient(at 90% 90%, rgba(194, 229, 252, 0.5) 0px, transparent 50%),
                           radial-gradient(at 50% 50%, rgba(226, 211, 248, 0.3) 0px, transparent 60%),
                           linear-gradient(to bottom, #fafdff, #f5f5fa);
            
            --text-primary: #334155;
            --text-secondary: #64748b;
            
            /* ÂØπËØùÊ°Ü */
            --modal-bg: rgba(255, 255, 255, 0.9);
            --modal-border: #e2e8f0; 
            --modal-shadow: 0 20px 50px rgba(200, 100, 200, 0.1);
            
            --accent-color: #000000; 
            --dot-user: #000000;
            --dot-bot: #000000;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--bg-color);
            background-image: var(--bg-gradient);
            color: var(--text-primary);
            font-family: var(--font-stack);
            transition: background 1s ease, color 1s ease;
            -webkit-font-smoothing: antialiased;
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            cursor: grab;
        }
        canvas:active { cursor: grabbing; }

        /* --- UI Â±Ç --- */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }
        .interactive { pointer-events: auto; }

        /* --- Ê®°ÊÄÅÊ°Ü (Modal) --- */
        #chat-modal, #name-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
            z-index: 20;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #chat-modal.active, #name-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .chat-content-wrapper, .name-modal-wrapper {
            background: var(--modal-bg);
            border: 1px solid var(--modal-border);
            box-shadow: var(--modal-shadow);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            transform: scale(0.95) translateY(20px);
            transition: transform 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
            overflow: hidden;
        }
        
        .chat-content-wrapper {
             width: 85%;
            max-width: 900px;
            height: 85%;
        }

        .name-modal-wrapper {
            width: 90%;
            max-width: 400px;
            padding: 30px;
        }

        #chat-modal.active .chat-content-wrapper, #name-modal.active .name-modal-wrapper {
            transform: scale(1) translateY(0);
        }

        /* ËÅäÂ§©Âå∫Âüü */
        #chat-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 60px 80px;
            scroll-behavior: smooth;
        }
        
        /* ÈöêËóèÂêçÂ≠óÊ®°Âºè CSS */
        #chat-scroll-area.hide-names .message-name {
            display: none;
        }

        @media (max-width: 640px) {
            #chat-scroll-area { padding: 30px 20px; }
            .chat-content-wrapper { width: 95%; height: 90%; }
        }

        /* --- Ê∂àÊÅØË°å (Á∫ØÂáÄÁâà) --- */
        .message-row {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            opacity: 0;
            animation: slideIn 0.5s ease forwards;
            align-items: flex-start;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .role-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 24px; /* Align with text roughly */
        }

        .message-container {
            display: flex;
            flex-direction: column;
            max-width: 90%;
        }

        .message-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .message-content {
            font-size: 1.05rem;
            line-height: 1.7;
            color: var(--text-primary);
            font-weight: 400;
        }
        
        /* AI Ê†∑Âºè (Â∑¶ÂØπÈΩê) */
        .message-row.assistant { flex-direction: row; }
        .message-row.assistant .role-dot {
            background-color: var(--dot-bot);
            border: 2px solid var(--dot-bot);
            box-shadow: 0 0 10px var(--dot-bot);
        }
        .message-row.assistant .message-container { align-items: flex-start; }
        .message-row.assistant .message-name { text-align: left; }

         /* user Ê†∑Âºè (Âè≥ÂØπÈΩê) */
        .message-row.user { flex-direction: row-reverse; }
        .message-row.user .role-dot {
            background-color: var(--dot-user);
            box-shadow: 0 0 10px var(--dot-user);
        }
        .message-row.user .message-container { align-items: flex-end; }
        .message-row.user .message-content { text-align: right; }
        .message-row.user .message-name { text-align: right; }


        /* Markdown */
        .markdown-body p { margin-bottom: 1.5em; }
        .markdown-body strong { color: var(--accent-color); font-weight: 600; }
        .markdown-body code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            background: rgba(150, 150, 150, 0.15);
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .markdown-body pre {
            background: rgba(0,0,0,0.03);
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid var(--modal-border);
            text-align: left; /* Ensure code blocks align left even in user messages if preferred, or inherit */
        }
        .message-row.user .markdown-body pre { text-align: left; } /* Keep code readable */
        
        [data-theme="night"] .markdown-body pre { background: rgba(255,255,255,0.05); }

        #chat-scroll-area::-webkit-scrollbar { width: 5px; }
        #chat-scroll-area::-webkit-scrollbar-thumb { background: var(--text-secondary); opacity: 0.3; border-radius: 10px; }

        /* ‰∏ä‰º†È°µ */
        #upload-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            z-index: 50;
            transition: opacity 0.5s;
        }
        .upload-card {
            background: var(--modal-bg);
            border: 1px solid var(--modal-border);
            box-shadow: var(--modal-shadow);
            backdrop-filter: blur(10px);
            padding: 50px;
            text-align: center;
            border-radius: 20px;
            max-width: 450px;
        }
        
        /* Input Styling */
        .name-input {
            width: 100%;
            background: rgba(0,0,0,0.1);
            border: 1px solid var(--text-secondary);
            color: var(--text-primary);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            outline: none;
            transition: border-color 0.3s;
        }
        .name-input:focus {
            border-color: var(--accent-color);
        }
        [data-theme="night"] .name-input { background: rgba(255,255,255,0.05); }

    </style>
</head>
<body>

    <canvas id="galaxy-canvas"></canvas>

    <div id="ui-layer">
        <!-- È°∂ÈÉ®Ê†è -->
        <div id="toolbar" class="absolute top-0 left-0 w-full p-6 flex justify-between items-center opacity-0 transition-opacity duration-500" style="pointer-events: none;">
            <div class="interactive flex items-center gap-4">
                <h1 class="text-xl font-bold tracking-widest opacity-80" style="font-family: var(--font-stack)">MEMORY CLOUD</h1>
            </div>
            
            <div class="interactive flex gap-4 items-center">
                <!-- ÊêúÁ¥¢Ê†è -->
                <div class="relative group">
                    <input type="text" id="search-box" placeholder="Search Memory..." class="bg-transparent border-b border-[var(--text-secondary)] px-2 py-1 text-sm focus:outline-none focus:border-[var(--accent-color)] transition w-48 text-right text-[var(--text-primary)] opacity-60 hover:opacity-100 placeholder-opacity-50">
                    <i data-lucide="search" class="w-4 h-4 absolute right-0 top-1/2 -translate-y-1/2 text-[var(--text-secondary)] pointer-events-none opacity-0 group-hover:opacity-0 transition"></i>
                </div>
                
                <!-- ÂØºÂÖ•ÊåâÈíÆ -->
                 <button onclick="openNameModal()" class="p-2 opacity-60 hover:opacity-100 transition rounded-full hover:bg-[var(--text-secondary)]/10" title="Import More">
                    <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                </button>

                <!-- ‰∏ªÈ¢òÊåâÈíÆ -->
                <button onclick="toggleTheme()" class="p-2 opacity-60 hover:opacity-100 transition rounded-full hover:bg-[var(--text-secondary)]/10">
                    <i data-lucide="moon" id="theme-icon"></i>
                </button>
            </div>
        </div>

        <!-- ÂàùÂßã‰∏ä‰º†ÁïåÈù¢ -->
        <div id="upload-screen">
            <div class="upload-card interactive">
                <div class="mb-6 flex justify-center">
                    <div class="w-16 h-16 rounded-full bg-[var(--accent-color)]/20 flex items-center justify-center animate-pulse">
                        <i data-lucide="cloud" class="w-8 h-8 text-[var(--accent-color)]"></i>
                    </div>
                </div>
                <h2 class="text-2xl font-bold mb-2 tracking-wide text-[var(--text-primary)]">ÈáèÂ≠êËÆ∞ÂøÜ‰∫ë</h2>
                <p class="text-sm text-[var(--text-secondary)] mb-8">Ready to Initialize</p>
                
                <button onclick="openNameModal()" class="px-8 py-3 rounded-lg border border-[var(--modal-border)] hover:bg-[var(--accent-color)]/10 hover:border-[var(--accent-color)] transition text-sm font-bold tracking-widest uppercase text-[var(--text-primary)]">
                    Load Data
                </button>
            </div>
        </div>
    </div>

    <!-- ÂêçÂ≠óËæìÂÖ•Ê®°ÊÄÅÊ°Ü -->
    <div id="name-modal">
        <div class="name-modal-wrapper interactive" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-6 text-[var(--text-primary)] text-center">Identity Configuration</h3>
            
            <label class="block text-xs text-[var(--text-secondary)] mb-2 uppercase tracking-wider">AI Name</label>
            <input type="text" id="ai-name-input" class="name-input" placeholder="e.g. Claude, GPTÔºåetc.">
            
            <label class="block text-xs text-[var(--text-secondary)] mb-2 uppercase tracking-wider">User Name</label>
            <input type="text" id="user-name-input" class="name-input" placeholder="e.g. User">
            
            <div class="flex justify-end gap-3 mt-4">
                <button onclick="closeNameModal()" class="px-4 py-2 text-sm text-[var(--text-secondary)] hover:text-[var(--text-primary)]">Cancel</button>
                <button onclick="confirmNameAndSelectFile()" class="px-6 py-2 rounded bg-[var(--accent-color)]/10 border border-[var(--modal-border)] text-[var(--text-primary)] text-sm font-bold hover:bg-[var(--accent-color)]/20 transition">
                    Select File
                </button>
            </div>
        </div>
    </div>

    <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• -->
    <input type="file" id="file-input" accept=".json" hidden>

    <!-- ÂØπËØùÊ°Ü -->
    <div id="chat-modal">
        <div class="chat-content-wrapper interactive" onclick="event.stopPropagation()">
            <!-- Â§¥ÈÉ® -->
            <div class="p-6 border-b border-[var(--modal-border)] flex justify-between items-center bg-transparent z-10">
                <div class="flex-1 min-w-0 mr-4">
                    <h2 id="modal-title" class="text-xl font-bold truncate text-[var(--text-primary)]">Untitled</h2>
                    <p id="modal-date" class="text-xs text-[var(--text-secondary)] mt-1 tracking-widest">LOADING...</p>
                </div>
                
                <div class="flex items-center gap-6">
                    <!-- Name Toggle -->
                    <div class="flex items-center gap-2" title="Toggle Name Display">
                        <span class="text-[10px] uppercase tracking-widest text-[var(--text-secondary)] hidden sm:block">Names</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="name-toggle" class="sr-only peer" checked onchange="toggleNames(this.checked)">
                            <div class="w-8 h-4 bg-[var(--text-secondary)]/30 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-[var(--accent-color)]"></div>
                        </label>
                    </div>

                    <button onclick="closeModal()" class="p-2 rounded-full hover:bg-[var(--text-secondary)]/10 transition">
                        <i data-lucide="x" class="w-6 h-6 text-[var(--text-primary)]"></i>
                    </button>
                </div>
            </div>
            <!-- ÂÜÖÂÆπ -->
            <div id="chat-scroll-area"></div>
        </div>
    </div>

    <script>
        // --- Ê†∏ÂøÉÈÖçÁΩÆ ---
        const CONFIG = {
            baseRepulsion: 80,
            zoomExtent: [0.1, 8],
            cloudRadiusMult: 4,
            particlesPerNode: 15,
            labelFadeStart: 1.5,
            labelFadeFull: 3.0
        };

        const PALETTE = {
            night: {
                core: ['#ffffff', '#e2e8f0'],
                cloudStops: [
                    { pos: 0, color: 'rgba(56, 189, 248, 0.4)' },
                    { pos: 0.4, color: 'rgba(129, 140, 248, 0.1)' },
                    { pos: 1, color: 'rgba(0, 0, 0, 0)' }
                ],
                particle: 'rgba(255, 255, 255, 0.6)'
            },
            day: {
                core: ['#ffffff', '#ffffff'],
                cloudStops: [
                    { pos: 0, color: 'rgba(244, 114, 182, 0.3)' },
                    { pos: 0.5, color: 'rgba(192, 132, 252, 0.1)' },
                    { pos: 1, color: 'rgba(255, 255, 255, 0)' }
                ],
                particle: 'rgba(255, 255, 255, 0.9)'
            }
        };

        let currentTheme = 'night';
        let simulation;
        let nodes = [];
        let width, height;
        let transform = d3.zoomIdentity;
        let activeNode = null;
        let targetNode = null;
        let isNameVisible = true; // ÈªòËÆ§ÊòæÁ§∫ÂêçÂ≠ó

        // ‰∏¥Êó∂Â≠òÂÇ®ËæìÂÖ•ÁöÑÂêçÂ≠ó
        let tempAIName = "";
        let tempUserName = "";

        const canvas = document.getElementById('galaxy-canvas');
        const ctx = canvas.getContext('2d');

        lucide.createIcons();

        // --- D3 Zoom ---
        const zoomBehavior = d3.zoom()
            .scaleExtent(CONFIG.zoomExtent)
            .on("zoom", (e) => { transform = e.transform; });

        d3.select(canvas).call(zoomBehavior).on("dblclick.zoom", null);

        // --- ÂàùÂßãÂåñ ---
        function init() {
            resize();
            window.addEventListener('resize', resize);
            renderLoop();
        }

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            if(simulation) {
                simulation.force("center", d3.forceCenter(width / 2, height / 2));
                simulation.alpha(0.3).restart();
            }
        }

        // --- ÂêçÂ≠óËæìÂÖ•‰∏éÊñá‰ª∂Â§ÑÁêÜÈÄªËæë ---
        const fileInput = document.getElementById('file-input');
        const uploadScreen = document.getElementById('upload-screen');
        const toolbar = document.getElementById('toolbar');
        const nameModal = document.getElementById('name-modal');
        const aiNameInput = document.getElementById('ai-name-input');
        const userNameInput = document.getElementById('user-name-input');

        function openNameModal() {
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°ÜÊàñ‰øùÁïô‰∏äÊ¨°ÁöÑÂÄº? ‰øùÁïôÊØîËæÉÊñπ‰æø
            // aiNameInput.value = '';
            // userNameInput.value = '';
            nameModal.classList.add('active');
        }

        function closeNameModal() {
            nameModal.classList.remove('active');
        }

        function confirmNameAndSelectFile() {
            tempAIName = aiNameInput.value.trim() || "AI";
            tempUserName = userNameInput.value.trim() || "User";
            closeNameModal();
            fileInput.click();
        }

        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
            // ÈáçÁΩÆ input value ‰ΩøÂæóÂêå‰∏ÄÊñá‰ª∂ÂèØ‰ª•Ë¢´ÂÜçÊ¨°Ëß¶Âèë change
            e.target.value = ''; 
        });

        // ÊãñÊãΩÊöÇ‰∏çÊîØÊåÅÂêçÂ≠óËæìÂÖ•ÔºåËøôÈáåÁÆÄÂåñÂ§ÑÁêÜÔºöÊãñÊãΩÁõ¥Êé•‰ΩøÁî®ÈªòËÆ§ÂêçÂ≠óÔºåÊàñÂºπÁ™óÊèêÁ§∫‰∏çÊîØÊåÅÊãñÊãΩ
        // ‰∏∫‰∫Ü‰ΩìÈ™å‰∏ÄËá¥ÊÄßÔºåÊã¶Êà™ÊãñÊãΩÂπ∂ÂºπÁ™ó
        document.body.addEventListener('dragover', e => e.preventDefault());
        document.body.addEventListener('drop', (e) => {
            e.preventDefault();
            if(e.dataTransfer.files.length) {
                // ÊãñÊãΩËß¶ÂèëÊó∂ÂÖàÂ≠òÊñá‰ª∂ÂºïÁî®ÔºåÂÜçÂºπÁ™ó
                const file = e.dataTransfer.files[0];
                // ËøôÈáåÁöÑÈÄªËæëÁ®çÂæÆÂ§çÊùÇÔºå‰∏∫‰∫ÜÁÆÄÂåñÔºåÊàë‰ª¨ÂÅáËÆæÊãñÊãΩÁõ¥Êé•Ëß¶ÂèëÂºπÁ™óÔºåÁ°ÆËÆ§ÂêéËØªÊñá‰ª∂
                // Êõ¥Â•ΩÁöÑÂÅöÊ≥ïÊòØÔºöÂ≠ò file -> openModal -> confirm -> process(file)
                // ËøôÈáå‰∏∫‰∫ÜÁÆÄÂçïÔºåÁõ¥Êé•Ëß¶Âèë openNameModalÔºåËÆ©Áî®Êà∑ÊâãÂä®ÈÄâÊñá‰ª∂
                alert("Please click 'Load Data' or the Import button to select files.");
            }
        });

        function handleFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    // ‰º†ÂÖ•ÂΩìÂâçËæìÂÖ•ÁöÑÂêçÂ≠ó
                    processData(json, tempAIName, tempUserName);
                    
                    if (uploadScreen.style.display !== 'none') {
                        uploadScreen.style.opacity = 0;
                        setTimeout(() => {
                            uploadScreen.style.display = 'none';
                            toolbar.classList.remove('opacity-0');
                            toolbar.style.pointerEvents = 'auto';
                        }, 500);
                    }
                } catch (err) {
                    alert('JSONËß£ÊûêÂ§±Ë¥•: ' + err);
                }
            };
            reader.readAsText(file);
        }

        // --- Êï∞ÊçÆÂ§ÑÁêÜ ---
        function processData(data, aiName, userName) {
            if (!Array.isArray(data)) {
                alert("Format invalid: Expected JSON Array");
                return;
            }

            const newNodes = data.filter(c => c.mapping || c.chat_messages).map((chat, i) => {
                let id, title, rawDate, sizeScore;
                
                // 1. ChatGPT Ê†ºÂºèËØÜÂà´
                if (chat.mapping) {
                    id = chat.id || chat.conversation_id;
                    title = chat.title || "Untitled Conversation";
                    rawDate = chat.create_time;
                    sizeScore = Object.keys(chat.mapping).length;
                } 
                // 2. Claude Ê†ºÂºèËØÜÂà´
                else if (chat.chat_messages) {
                    id = chat.uuid;
                    title = chat.name || "Untitled Conversation";
                    rawDate = chat.created_at;
                    sizeScore = chat.chat_messages.length * 2.5; // Claude Âè™ÊúâÊ∂àÊÅØÂàóË°®Ôºå‰πò‰ª•Á≥ªÊï∞‰ΩøÂÖ∂‰∏é GPT Ê†ëÁªìÊûÑÂ§ßÂ∞èËßÇÊÑüËøë‰ºº
                }

                // Áªü‰∏ÄÊó∂Èó¥Êà≥ (Áßí)
                let dateVal;
                if (typeof rawDate === 'number') {
                    dateVal = rawDate;
                } else if (typeof rawDate === 'string') {
                    dateVal = new Date(rawDate).getTime() / 1000;
                } else {
                    dateVal = Date.now() / 1000;
                }

                const r = Math.min(Math.max(sizeScore / 8, 2), 6);
                
                const cloudParticles = [];
                for(let j=0; j<CONFIG.particlesPerNode; j++) {
                    const u1 = Math.random();
                    const u2 = Math.random();
                    const z = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
                    const dist = Math.abs(z) * r * 1.5; 
                    const angle = Math.random() * Math.PI * 2;
                    cloudParticles.push({
                        x: Math.cos(angle) * dist,
                        y: Math.sin(angle) * dist,
                        size: Math.random() * 1.2 + 0.3, 
                        alpha: Math.random() * 0.5 + 0.2
                    });
                }

                // ËÆ°ÁÆóÂÖ®Â±ÄÂÅèÁßªÔºåÈÅøÂÖçÊñ∞ËäÇÁÇπÁõ¥Êé•ÈáçÂè†Âú®ÊóßËäÇÁÇπ‰∏ä (Â¶ÇÊûúÂ∑≤ÁªèÊúâËäÇÁÇπ)
                let offsetX = width/2;
                let offsetY = height/2;
                if(nodes.length > 0) {
                     offsetX += (Math.random() - 0.5) * 400;
                     offsetY += (Math.random() - 0.5) * 400;
                }

                return {
                    id: id || Math.random().toString(36),
                    x: offsetX + (Math.random() - 0.5) * 200,
                    y: offsetY + (Math.random() - 0.5) * 200,
                    r: r,
                    cloudParticles: cloudParticles,
                    title: title,
                    date: dateVal,
                    chatData: chat, // Â≠òÂÇ®ÂéüÂßãÊï∞ÊçÆ
                    colorIndex: nodes.length + i, // Á°Æ‰øùÈ¢úËâ≤ÂàÜÂ∏É
                    customAIName: aiName,   // ÁªëÂÆöÂêçÂ≠óÂà∞ËäÇÁÇπ
                    customUserName: userName
                };
            });
            
            if (newNodes.length === 0) {
                alert("No valid conversations found. Please upload a standard ChatGPT or Claude JSON export.");
                return;
            }

            // ËøΩÂä†ËäÇÁÇπËÄå‰∏çÊòØÊõøÊç¢
            nodes = nodes.concat(newNodes);

            if (!simulation) {
                simulation = d3.forceSimulation(nodes)
                    .force("charge", d3.forceManyBody().strength(-CONFIG.baseRepulsion))
                    .force("center", d3.forceCenter(width / 2, height / 2))
                    .force("collision", d3.forceCollide().radius(d => d.r * CONFIG.cloudRadiusMult * 0.5))
                    .alphaDecay(0.02)
                    .on("tick", () => {});
            } else {
                // Êõ¥Êñ∞‰ªøÁúüÊï∞ÊçÆÂπ∂ÈáçÂêØ
                simulation.nodes(nodes);
                simulation.alpha(0.5).restart();
            }
                
            canvas.addEventListener('click', onCanvasClick);
        }

        // --- Ê∏≤ÊüìÂæ™ÁéØ ---
        function renderLoop() {
            ctx.clearRect(0, 0, width, height);
            ctx.save();
            ctx.translate(transform.x, transform.y);
            ctx.scale(transform.k, transform.k);

            const palette = PALETTE[currentTheme];
            
            // ËÆ°ÁÆóÊ†áÁ≠æÈÄèÊòéÂ∫¶ (LOD Logic)
            let labelAlpha = 0;
            if (transform.k > CONFIG.labelFadeStart) {
                labelAlpha = (transform.k - CONFIG.labelFadeStart) / (CONFIG.labelFadeFull - CONFIG.labelFadeStart);
                labelAlpha = Math.min(Math.max(labelAlpha, 0), 1);
            }

            nodes.forEach(node => {
                const opacity = (activeNode && activeNode !== node) ? 0.1 : 1;
                ctx.globalAlpha = opacity;

                // 1. ÁîµÂ≠ê‰∫ë
                const cloudRadius = node.r * CONFIG.cloudRadiusMult;
                const gradient = ctx.createRadialGradient(node.x, node.y, node.r * 0.5, node.x, node.y, cloudRadius);
                palette.cloudStops.forEach(stop => gradient.addColorStop(stop.pos, stop.color));
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(node.x, node.y, cloudRadius, 0, Math.PI * 2);
                ctx.fill();

                // 2. Á≤íÂ≠ê
                if (transform.k > 0.4 || activeNode === node) {
                    ctx.fillStyle = palette.particle;
                    node.cloudParticles.forEach(p => {
                        ctx.globalAlpha = p.alpha * opacity;
                        ctx.beginPath();
                        ctx.arc(node.x + p.x, node.y + p.y, p.size, 0, Math.PI * 2);
                        ctx.fill();
                    });
                }

                // 3. Ê†∏ÂøÉ
                ctx.globalAlpha = opacity;
                ctx.fillStyle = palette.core[node.colorIndex % palette.core.length];
                if(currentTheme === 'night') {
                    ctx.shadowBlur = (targetNode === node) ? 30 : 15; // ÊêúÁ¥¢È´ò‰∫Æ
                    ctx.shadowColor = ctx.fillStyle;
                } else {
                    ctx.shadowBlur = 0;
                }
                ctx.beginPath();
                ctx.arc(node.x, node.y, node.r * 0.8, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
                
                // 4. Ê†áÈ¢ò (Êô∫ËÉΩ LOD)
                if (labelAlpha > 0 && !activeNode) {
                    ctx.globalAlpha = labelAlpha;
                    ctx.fillStyle = currentTheme === 'night' ? '#ccc' : '#555';
                    ctx.font = '2.5px -apple-system, BlinkMacSystemFont, sans-serif'; // ‰∏ñÁïåÂùêÊ†áÁ≥ªÂ≠ó‰ΩìË¶ÅÂ∞è
                    ctx.textAlign = 'center';
                    ctx.fillText(node.title.substring(0, 15) + (node.title.length>15 ? '...' : ''), node.x, node.y + node.r * 2 + 3);
                }
            });

            ctx.restore();
            requestAnimationFrame(renderLoop);
        }

        // --- ‰∫§‰∫íÈÄªËæë ---
        function onCanvasClick(e) {
            const clickX = (e.clientX - transform.x) / transform.k;
            const clickY = (e.clientY - transform.y) / transform.k;

            let clickedNode = null;
            // ÂèçÂêëÈÅçÂéÜÔºå‰ºòÂÖàÈÄâ‰∏≠‰∏äÂ±ÇËäÇÁÇπ
            for (let i = nodes.length - 1; i >= 0; i--) {
                const node = nodes[i];
                const dx = clickX - node.x;
                const dy = clickY - node.y;
                if (dx*dx + dy*dy < (node.r * 4) * (node.r * 4)) {
                    clickedNode = node;
                    break;
                }
            }

            if (clickedNode) {
                openNode(clickedNode);
            } else if (activeNode) {
                closeModal();
            }
        }

        function openNode(node) {
            activeNode = node;
            const targetScale = 2.5;
            const targetX = width / 2 - node.x * targetScale;
            const targetY = height / 2 - node.y * targetScale;

            d3.select(canvas).transition().duration(800)
                .call(zoomBehavior.transform, d3.zoomIdentity.translate(targetX, targetY).scale(targetScale));

            const modal = document.getElementById('chat-modal');
            const title = document.getElementById('modal-title');
            const date = document.getElementById('modal-date');
            const scrollArea = document.getElementById('chat-scroll-area');

            title.innerText = node.title;
            date.innerText = new Date(node.date * 1000).toLocaleString();
            
            // ‰º†ÈÄíËØ•ËäÇÁÇπÁªëÂÆöÁöÑÂêçÂ≠ó
            renderChatContent(node.chatData, scrollArea, node.customAIName, node.customUserName);
            
            // ÂêåÊ≠• Toggle UI Áä∂ÊÄÅ
            document.getElementById('name-toggle').checked = isNameVisible;
            toggleNames(isNameVisible);

            modal.classList.add('active');
            
            document.getElementById('toolbar').style.opacity = '0';
        }

        function closeModal() {
            document.getElementById('chat-modal').classList.remove('active');
            activeNode = null;
            targetNode = null; // Ê∏ÖÈô§È´ò‰∫Æ
            document.getElementById('toolbar').style.opacity = '1';
        }

        // --- ÊêúÁ¥¢ÈÄªËæë ---
        document.getElementById('search-box').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const term = e.target.value.toLowerCase();
                if (!term) return;

                const match = nodes.find(n => n.title.toLowerCase().includes(term));
                if (match) {
                    targetNode = match;
                    const searchScale = 3.5; 
                    const targetX = width / 2 - match.x * searchScale;
                    const targetY = height / 2 - match.y * searchScale;

                    d3.select(canvas).transition().duration(1200).ease(d3.easeCubicOut)
                        .call(zoomBehavior.transform, d3.zoomIdentity.translate(targetX, targetY).scale(searchScale));
                } else {
                    e.target.style.borderColor = 'red';
                    setTimeout(() => e.target.style.borderColor = 'var(--text-secondary)', 500);
                }
            }
        });

        // --- ÂêçÂ≠óÊòæÁ§∫ÂàáÊç¢ ---
        function toggleNames(checked) {
            isNameVisible = checked;
            const area = document.getElementById('chat-scroll-area');
            if(checked) {
                area.classList.remove('hide-names');
            } else {
                area.classList.add('hide-names');
            }
        }

        // --- ËÅäÂ§©Ê∏≤Êüì ---
        function renderChatContent(chat, container, aiName, userName) {
            container.innerHTML = '';
            
            let messages = [];

            // 1. ChatGPT ÁªìÊûÑËß£Êûê (Ê†ëÁä∂ÁªìÊûÑ)
            if (chat.mapping) {
                let currentNode = chat.current_node;
                
                while (currentNode) {
                    const node = chat.mapping[currentNode];
                    if (node && node.message) {
                        const role = node.message.author.role;
                        if (node.message.content && node.message.content.parts && node.message.content.parts.length > 0) {
                            const rawText = node.message.content.parts.join('\n');
                            if (rawText.trim() !== '' && (role === 'user' || role === 'assistant')) {
                                messages.unshift({ role, content: rawText });
                            }
                        }
                    }
                    currentNode = node ? node.parent : null;
                }
            } 
            // 2. Claude ÁªìÊûÑËß£Êûê (Á∫øÊÄßÂàóË°®)
            else if (chat.chat_messages) {
                messages = chat.chat_messages.map(msg => {
                    let role = 'user';
                    // Claude ÁöÑ sender Âè™Êúâ 'human' Âíå 'assistant'
                    if (msg.sender === 'assistant') role = 'assistant';
                    
                    return {
                        role: role,
                        content: msg.text || ""
                    };
                }).filter(m => m.content && m.content.trim() !== '');
            }

            if (messages.length === 0) {
                container.innerHTML = `<div class="text-center opacity-50 mt-10">NO TEXT CONTENT FOUND</div>`;
                return;
            }

            messages.forEach(msg => {
                const row = document.createElement('div');
                row.className = `message-row ${msg.role}`;
                
                const dot = document.createElement('div');
                dot.className = 'role-dot';

                // Êñ∞ÁöÑÂÆπÂô®ÁªìÊûÑ
                const containerDiv = document.createElement('div');
                containerDiv.className = 'message-container';

                // ÂêçÂ≠ó Div
                const nameDiv = document.createElement('div');
                nameDiv.className = 'message-name';
                nameDiv.innerText = msg.role === 'assistant' ? aiName : userName;

                // ÂÜÖÂÆπ Div
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content markdown-body';
                contentDiv.innerHTML = marked.parse(msg.content);

                containerDiv.appendChild(nameDiv);
                containerDiv.appendChild(contentDiv);

                row.appendChild(dot);
                row.appendChild(containerDiv);
                
                container.appendChild(row);
            });
            
            container.querySelectorAll('a').forEach(a => a.target = '_blank');
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'night' ? 'day' : 'night';
            document.documentElement.setAttribute('data-theme', currentTheme);
            const icon = document.getElementById('theme-icon');
            icon.setAttribute('data-lucide', currentTheme === 'day' ? 'moon' : 'sun');
            lucide.createIcons();
            if(activeNode === null) renderLoop(); 
        }

        init();
    </script>
</body>
</html>
